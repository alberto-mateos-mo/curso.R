---
title: De qu칠 hablamos cuando hablamos
author: Dave
date: '2021-08-25'
slug: de-que-hablamos
categories:
  - R
tags:
  - Data Cleansing
  - Text Analysis
  - Wordcloud
---

# An치lisis y limpeza de textos.

Hola Ameyalli 游땕, 쯔lguna vez te has preguntado de qu칠 hablamos cuando hablamos?, 쯛abr치 alguna palabra que m치s utilizas?

Bueno pues en este proyecto analizaremos nuestra conversaci칩n (que emoci칩n) para tratar de identificar de qu칠 es de lo que m치s hablamos, si usamos alguna palabra con mayor frecuencia, o bueno realmente buscaremos si sale algo interesante gg.

Antes de pasar al ejercicio te quiero platicar que el an치lisis de textos tiene muchas aplicaciones, por ejemplo qu칠 diran los comentarios de las fotos de IG de una marca, o los comentarios de FB en un post publicitario. Ahora que est치n de moda los bots, se puede analizar qu칠 es lo que le preguntan las personas al bot y usar eso para mejorarlo.

쯊e ha tocado responder alguna encuesta de satisfacci칩n de una tienda comercial? Pues te imaginas tener que leer todos los comentarios, uno por uno, para saber de qu칠 se queja la gente, que horror; pero justamente podemos usar el an치lisis de textos para identificar eso de forma r치pida y casi que sin esfuerzo.

Pero bueno ahora s칤 vamos al ejercicio.

## Creando el proyecto

Para empezar abriremos RStudio y vamos a crear un __Proyecto__ para trabajar en este proyecto (valga la redundancia). Al crear un proyecto en RStudio lo que haremos ser치 aislar los scripts y documentos del mismo dentro de una carpeta, la idea es que R tenga acceso solo a los elementos de esta carpeta, con ello mantendremos un orden muy claro de nuestro trabajo y evitaremos mezclar proyectos.

Te recomiendo leer un poco m치s sobre el uso de proyectos en RStudio en [esta liga](https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects).

Ya que tenemos RStudio abierto, daremos click en la pesta침a __File__ y luego en __New Project__:

![](/post/2021-08-24-de-que-hablamos_files/new_project.png)

Una vez hecho eso, se nos desplegar치n las siguientes opciones:

![](/post/2021-08-24-de-que-hablamos_files/new_project_options.png)

Por ahora solo nos centraremos en las opciones __New Directory__ y __Existing Directory__.

La primera (__New Directory__) la usaremos cuando a칰n no hayamos creado una carpeta para nuestro proyecto, la segunda (__Existing DIrectory__) la usar칠mas si es que ya existe una carpeta en nuestros documentos que est칠 destinada al proyecto.

En nuestro caso usaremos la primera opci칩n y enseguida se nos despelagar치n las siguientes opciones:

![](/post/2021-08-24-de-que-hablamos_files/new_directory.png)

Ah칤 seleccionaremos __New Project__ y veremos lo siguiente:

![](/post/2021-08-24-de-que-hablamos_files/new_directory_options.png)

En __Directory name__ escribiremos el nombre de la carpeta para nuestro proyecto, ah칤 podemos poner e.g. _analisis_chat_ o alg칰n otro nombre que te parezca adecuado. Mi recomendaci칩n es que el nombre est칠 escrito en min칰sculas, sin espacios (en lugar de ellos podemos usar guiones bajos) y sin caracteres especiales (como acentos).

En la opci칩n __Create project as subdirectory of:__ escogeremos la carpeta donde queremos que se cree la carpeta del proyecto (esto seguro se ley칩 confuso pero creeme que s칤 tiene sentido 游땐).

Por ejemplo, tal vez dentro de la carpeta __Mis documentos__ de tu computadora tengas una carpeta llamada __curso_R__ destinada a este curso, entonces buscaremos y elegiremos justamente la carpeta __curso_R__.

Finalmente damos click en __Create Project__.

## An치lizando nuestro chat 游땸

Para empezar dale click [aqu칤](https://drive.google.com/file/d/1E0_h9BNbb8v3giLmAxPqJR9JAcXEd4a6/view?usp=sharing) para descargar nuestra conversaci칩n de whatsapp.

Guarda el archivo en la carpeta que hayas creado en el paso anterior.

<!-- Ahora, hay dos formas en las que puedes seguir los ejercicios, una es continuar leyendo y la otra es descargar y abrir [este script](www.example.org) en RStudio y seguir las instrucciones ah칤. -->

### Prerequisitos

Para muchas de las cosas que haremos usaremos __Paquetes de R__ que otras personas programaron. Estos paquetes son conjuntos de funciones creadas para darle a R ciertas funciones adicionales, [aqu칤](https://hbctraining.github.io/Intro-to-R-flipped/lessons/04_introR_packages.html) puedes leer un poco m치s sobre los paquetes de R.

Por ejemplo para hacer gr치ficas en R nosotros podr칤amos crear nuestras propias funciones pero eso ser칤a perder un poco el tiempo pues ya alguien se preocup칩 por nosotros y dise침o un paquete que lo hace m치s sencillo, nosotros solo debemos instalar ese paquete, cargarlo y empezar a usarlo.

Para este proyecto necesitaremos algunos paquetes que nos har치n la vida m치s f치cil para analizar nuestras conversaciones, los paquetes que usaremos son:

- Tidyverse: Este es un paquete que contiene otros paquetes dise침ados espec칤ficamente para tareas de _Data Science_ (m치s sobre este ecos칤stema [aqu칤](https://www.tidyverse.org/)).

- tm: Este paquete se usa para tareas de miner칤a de texto (de ah칤 su nombre, Text Mining), [por ac치](https://cran.r-project.org/web/packages/tm/vignettes/tm.pdf) hay una introducci칩n no muy amena pero interesante.

- wordcloud: Este paquete lo usaremos para crear unos gr치ficos llamados nubes de palabras, como el nombre nos dice son gr치ficos que nos mostrar치n palabras, [aqu칤](http://blog.fellstat.com/?cat=11) puedes ver algunos ejemplos.

Para instalar esos paquetes copiaremos y pegaremos lo siguiente en la consola de R y le daremos enter:

```{r, eval=FALSE}
install.packages("tidyverse") ## Esta instaci칩n tarda un poco, se paciente :)
```

```{r, eval=FALSE}
install.packages("tm") ## Esta instaci칩n tarda un poco, se paciente :)
```

```{r, eval=FALSE}
install.packages("wordcloud") ## Esta instaci칩n tarda un poco, se paciente :)
```


### Leyendo el archivo en R

Antes de cualquier cosa lo primero que tenemos poner en nuestro script son los paquetes que usaremos en el an치lisis:

```{r, eval=FALSE}
library(dplyr) ## Este paquete no lo instalamos directamente pero se instal칩 al instalar el paquete tidyverse
library(tm)
library(wordcloud)
```


Muy bien continuemos...

Para lo siguiente la idea es que vayas copiando el c칩digo y pegandolo en el script de R de tu sesi칩n de RStudio y que lo vayas corriendo para ver qu칠 sale.

El archivo de nuestra conversaci칩n es de tipo __CSV__ es decir una tabla con valores separados por comas (Comma-Separated Values). Este no es el 칰nico tipo de archivos que se pueden leer en R, [ac치](https://www.datafiles.samhsa.gov/get-help/format-specific-issues/how-do-i-read-data-r) puedes leer un poco sobre algunos de los archivos m치s comunes que se pueden abrir en R.

Para leer nuestro chat, usaremos lo siguiente:

```{r, eval=FALSE}
chat <- read.csv("wa_chat.csv")
```

Si revisas el panel del ambiente, ver치s que hay un objeto llamado chat, dale click ah칤 para abrir la tabla que acabamos de cargar, revisala brevemente, notar치s que en la tabla hay dos columnas, `persona` y `mensaje` 쯦e parece que los mensajes se leyeron correctamente?

Es probable que no, seguramente ver치s algunos simbolos raros, quiz치 algunos de ellos est치n en sitios donde deber칤a haber una letra con acento. Esto ocurre justamente porque R no sabe muy bien c칩mo interpretar los acentos, para leerlos correctamente tenemos que decirle c칩mo _decodificarlos_, si cargamos los datos del siguiente modo corregiremos ese "error":

```{r, eval=FALSE}
chat <- read.csv("dequehablamos/wa_chat.csv", encoding = "UTF-8")
```

#### Un primer an치lisis

Algo que podemos intentar responder primero es, 쯤ui칠n ha enviado m치s mensajes? Para responder esto haremos una tabla de frecuencias de la columna `persona`:

__N.B.__ Te sugiero revisar con detenimiento la forma en que _accedemos_ a la columa deseada de la tabla.

```{r, eval=FALSE}
table(chat$persona)
```

쮺u치l fue el resultado?, 쯦e lo esperabas?

Otra primera pregunta interesante ser칤a 쯤u칠 tan largos son los mensajes que intercambiamos?, para ello primero crearemos una nueva columna (o variable) que tenga la cantidad de caract칠res de cada mensaje:

__N.B__ Nuevamente, te sugiero revisar detenidamente esta l칤nea de c칩digo con la intenci칩n de desifrar c칩mo est치 funcionando.

```{r, eval=FALSE}
chat$longitud_mensaje <- nchar(chat$mensaje)
```

Ahora podemos calcular algunas estad칤sticas _resumen_ de la longitud del mensaje:

```{r, eval=FALSE}
summary(chat$longitud_mensaje)
```

쯈u칠 te parecen estos resultados?

Algo que a mi me llama la atenci칩n es el valor m치ximo de caract칠res en un mensaje, el cu치l est치 muy por arriba del n칰mero promedio de caract칠res que usamos.

쮺u치l ser치 ese mensaje y quien lo habr치 enviado?

Para determinar cu치l es la _posici칩n_ del mensaje m치s largo usamos lo siguiente:

```{r, eval=FALSE}
which.max(chat$longitud_mensaje)
```

Ya que tengamos ese valor podemos encontrar a la persona que lo mand칩 y al mensaje de la siguiente forma:

```{r, eval=FALSE}
chat$persona[aqu칤_pones_el_n칰mero_que_salio]
chat$mensaje[aqu칤_pones_el_n칰mero_que_salio]
```

o bien:

```{r, eval=FALSE}
chat$persona[which.max(chat$longitud_mensaje)]
chat$mensaje[which.max(chat$longitud_mensaje)]
```

Ok...

Ya sabemos qui칠n mand칩 el mensaje m치s largo, 쯥er치 que esa misma personas siempre manda mensajes largos?, para averiguarlo calcularemos la longitud promedio de los mensajes para cada persona:

__N.B__ Estas l칤neas de c칩digo pueden ser un poco m치s complicadas, sin embargo la sintaxis es m치s amigable al leerla, analiza con cuidado c칩mo estamos haciendo el c치lculo. Te platica adem치s que estas funciones provienen del paquete `dplyr`.

```{r, eval=FALSE}
chat %>% 
  group_by(persona) %>% 
  summarise(longitud_promedio = mean(longitud_mensaje))
```

쯈ui칠n tiende a mandar mensajes m치s largos?, 쯖칩mo se relaciona este resultado con el anterior sobre qui칠n manda m치s mensajes?

Modifica ese c칩digo para calcular la mediana de la longitud del mensaje por persona, hagamos ese ejercicio tambi칠n calculando la longitud del mensaje m치s peque침o y el m치s grande de cada persona.

#### 쮺u치les son las palabras que m치s usamos?

Ahora lo que haremos ser치 analizar los mensajes para obtener frecuencias por palabra y poder determinar si hay alguna palabra que usemos en mayor medida.

Para hacerlo usaremos funciones del paquete `tm`.

Lo primero ser치 crear un objeto de tipo __Corpus__ (o corpora) b치sicamente esto es un objeto que le dice a R que lo que est치 ah칤 es _lenguaje natural_ o lenguaje del que usamos las personas para comunicarnos:

```{r, eval=FALSE}
chat_corpus <- Corpus(VectorSource(chat$mensaje))
```

A continuaci칩n lo que haremos ser치 limpiar esos textos, por ejemplo todo lo pondremos en may칰sculas para que las palabras como _hola_, _Hola_ y _HOLA_ sean consideradas como la misma. Tambi칠n quitaremos los posibles n칰meros que puedan aparecer pues como tal no son palabras y adicionalmente quitaremos signos de puntuaci칩n pues tampoco es relevante saber cu치les usamos.

Como siempre, te sugiero detenerte lo necesario para tratar de enteder lo que est치 haciendo el c칩digo:

```{r, eval=FALSE}
chat_corpus <- chat_corpus %>% 
  tm_map(content_transformer(tolower)) %>% 
  tm_map(content_transformer(removeNumbers)) %>% 
  tm_map(content_transformer(removePunctuation))
```

Muy bien, ahora lo que haremos es una matriz de t칠rminos, esto es una matriz que nos diga en qu칠 mensajes se usa cada palabra identificada.

```{r, eval=FALSE}
chat_matrix <- TermDocumentMatrix(chat_corpus)

chat_matrix <- as.matrix(chat_matrix)
```

Si en el ambiente le das click al objeto `chat_matrix` ver치s que es una matriz algo rara, dificil de entender qu칠 es lo que hay ah칤.

Con el siguiente c칩digo creamos una tabla de frecuencias de las palabras:

```{r, eval=FALSE}
tmp <- sort(rowSums(chat_matrix), decreasing=TRUE)

chat_words <- data.frame(word = names(tmp), freq = tmp)
```

Si le das click al objeto `chat_words` podras ver la tabla de frecuencias ordenada de mayor a menor, 쯦e llama la atenci칩n algo de esa tabla?, 쯖rees que est치 _bien hecha_?

Antes de corregir algunos errores de esa tabla haremos una primera nube de palabras con esa informaci칩n, la nube la haremos con un m치ximo de 100 palabras:

```{r, eval=FALSE}
wordcloud(words = chat_words$word, freq = chat_words$freq, max.words = 100)
```

춰Perfecto!

O quiz치 no tanto, seguro habr치s visto que algunas de las palabras m치s frecuente son palabras que no fueron usadas como tal en la conversaci칩n, otras de ellas son en realidad preposiciones, en el espa침ol las preposiciones son muy usadas porque permiten ligar palabras para formar oraciones por lo tanto habr치 que quitar esas palabras de la conversaci칩n para tratar de identificar de mejor forma las palabras que m치s usamos.

Recuerdas la parte de c칩digo donde quitamos los n칰meros y los signos de puntuaci칩n? Te invito a agregarle a ese c칩digo lo siguiente para quitar ahora lo que mencionamos.

```{r, eval=FALSE}
tm_map(removeWords, c("media", "omitted")) %>% 
  tm_map(removeWords, stopwords("spanish"))
```

Ahora podemos repetir el proceso de creaci칩n de la tabla de frecuencias y de la nube de palabras:

```{r, eval=FALSE}
chat_matrix <- TermDocumentMatrix(chat_corpus)

chat_matrix <- as.matrix(chat_matrix)
```

```{r, eval=FALSE}
tmp <- sort(rowSums(chat_matrix), decreasing=TRUE)

chat_words <- data.frame(word = names(tmp), freq = tmp)
```

```{r, eval=FALSE}
wordcloud(words = chat_words$word, freq = chat_words$freq, max.words = 100)
```

쯈u칠 tal se ve ahora?

Como ejercicio para que puedas practicar algunas cosas y empieces a perderle el miedo a R te dejo lo siguiente:

- Revisa c칩mo puedes ponerle color a la nube de palabras, para esto te recomiendo revisar estos tutoriales:
  
    - http://www.sthda.com/english/wiki/text-mining-and-word-cloud-fundamentals-in-r-5-simple-steps-you-should-know
  
    - https://towardsdatascience.com/create-a-word-cloud-with-r-bde3e7422e8a

- Repite el ejericio para crear una nube de palabras solamente con mis mensajes, 쯖u치les son las palabras que m치s uso?

- Repite el ejericio para crear una nube de palabras solamente con tus mensajes, 쯖u치les son las palabras que m치s usas?

Que te diviertas :)

Recuerda que puedes buscarme cuando sea y a la hora que sea por si necesitas ayuda.